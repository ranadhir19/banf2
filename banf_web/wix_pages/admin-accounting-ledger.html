<!-- 
BANF Admin Accounting Ledger - Wix Page
Page Name: admin-accounting
URL: /admin/accounting

Instructions to implement in Wix:
1. Create a new page in the Admin section named "Accounting Ledger"
2. This page should be accessible only to logged-in admins with 'finances' permission
3. Connect the Velo backend code from accounting-ledger.jsw
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Ledger - BANF Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --banf-green: #006A4E;
            --banf-orange: #F42A41;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.income {
            border-left: 4px solid #28a745;
        }
        
        .stat-card.expense {
            border-left: 4px solid #dc3545;
        }
        
        .stat-card.balance {
            border-left: 4px solid var(--banf-green);
        }
        
        .stat-card.pending {
            border-left: 4px solid #ffc107;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stat-value.positive { color: #28a745; }
        .stat-value.negative { color: #dc3545; }
        
        .ledger-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .ledger-card .card-header {
            background: linear-gradient(135deg, var(--banf-green) 0%, #008B5C 100%);
            color: white;
            padding: 20px 25px;
            border: none;
        }
        
        .ledger-table {
            width: 100%;
        }
        
        .ledger-table th {
            background: #f8f9fa;
            font-weight: 600;
            padding: 15px;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }
        
        .ledger-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .ledger-table tr:hover {
            background: #f8f9fa;
        }
        
        .amount-credit {
            color: #28a745;
            font-weight: 600;
        }
        
        .amount-debit {
            color: #dc3545;
            font-weight: 600;
        }
        
        .badge-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .btn-add-record {
            background: linear-gradient(135deg, var(--banf-green) 0%, #008B5C 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .btn-add-record:hover {
            background: linear-gradient(135deg, #005540 0%, #006A4E 100%);
            color: white;
        }
        
        .category-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .category-membership { background: #cce5ff; color: #004085; }
        .category-event { background: #d4edda; color: #155724; }
        .category-sponsorship { background: #fff3cd; color: #856404; }
        .category-venue { background: #f8d7da; color: #721c24; }
        .category-food { background: #e2e3e5; color: #383d41; }
        
        .running-balance {
            font-weight: 600;
            color: var(--banf-green);
        }
        
        .chart-container {
            height: 300px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0"><i class="fas fa-book me-2"></i>BANF Accounting Ledger</h4>
                    <small class="opacity-75">Financial Management System</small>
                </div>
                <div>
                    <a href="/admin/dashboard" class="btn btn-outline-light btn-sm me-2">
                        <i class="fas fa-arrow-left me-1"></i>Dashboard
                    </a>
                    <button class="btn btn-light btn-sm" onclick="exportLedger()">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card income">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Total Income</p>
                            <div class="stat-value positive" id="totalIncome">$0.00</div>
                        </div>
                        <i class="fas fa-arrow-up fa-2x text-success opacity-50"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card expense">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Total Expenses</p>
                            <div class="stat-value negative" id="totalExpense">$0.00</div>
                        </div>
                        <i class="fas fa-arrow-down fa-2x text-danger opacity-50"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card balance">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Net Balance</p>
                            <div class="stat-value" id="netBalance">$0.00</div>
                        </div>
                        <i class="fas fa-balance-scale fa-2x text-primary opacity-50"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card pending">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Pending Approval</p>
                            <div class="stat-value" id="pendingCount">0</div>
                        </div>
                        <i class="fas fa-clock fa-2x text-warning opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="row align-items-end">
                <div class="col-md-2">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-2">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="filterType">
                        <option value="all">All</option>
                        <option value="income">Income Only</option>
                        <option value="expense">Expense Only</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="filterCategory">
                        <option value="">All Categories</option>
                        <optgroup label="Income">
                            <option value="membership">Membership</option>
                            <option value="event">Events</option>
                            <option value="sponsorship">Sponsorship</option>
                            <option value="donation">Donations</option>
                        </optgroup>
                        <optgroup label="Expense">
                            <option value="venue">Venue</option>
                            <option value="food">Food</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="supplies">Supplies</option>
                        </optgroup>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="applyFilters()">
                        <i class="fas fa-filter me-1"></i>Apply
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-add-record w-100" data-bs-toggle="modal" data-bs-target="#addRecordModal">
                        <i class="fas fa-plus me-1"></i>Add Record
                    </button>
                </div>
            </div>
        </div>

        <!-- Ledger Table -->
        <div class="ledger-card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Transaction Ledger</h5>
                    <span class="badge bg-light text-dark" id="transactionCount">0 transactions</span>
                </div>
            </div>
            <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;">
                <table class="ledger-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th class="text-end">Debit</th>
                            <th class="text-end">Credit</th>
                            <th class="text-end">Balance</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody">
                        <!-- Sample data - will be populated from database -->
                        <tr>
                            <td>02/01/2026</td>
                            <td>
                                <strong>Membership Payment - Sharma Family</strong><br>
                                <small class="text-muted">Receipt: BANF-INC-202602-0001</small>
                            </td>
                            <td><span class="category-badge category-membership">Membership</span></td>
                            <td></td>
                            <td class="amount-credit">$340.00</td>
                            <td class="running-balance">$24,225.00</td>
                            <td><span class="badge badge-approved">Approved</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>01/28/2026</td>
                            <td>
                                <strong>Saraswati Puja Venue Booking</strong><br>
                                <small class="text-muted">Receipt: BANF-EXP-202601-0012</small>
                            </td>
                            <td><span class="category-badge category-venue">Venue</span></td>
                            <td class="amount-debit">$1,500.00</td>
                            <td></td>
                            <td class="running-balance">$23,885.00</td>
                            <td><span class="badge badge-approved">Approved</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>01/25/2026</td>
                            <td>
                                <strong>Event Catering Deposit</strong><br>
                                <small class="text-muted">Receipt: BANF-EXP-202601-0011</small>
                            </td>
                            <td><span class="category-badge category-food">Food</span></td>
                            <td class="amount-debit">$500.00</td>
                            <td></td>
                            <td class="running-balance">$25,385.00</td>
                            <td><span class="badge badge-pending">Pending</span></td>
                            <td>
                                <button class="btn btn-sm btn-success me-1" title="Approve" onclick="approveRecord('xxx')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Monthly Summary Chart -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="ledger-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Monthly Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="ledger-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Category Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Record Modal -->
    <div class="modal fade" id="addRecordModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--banf-green) 0%, #008B5C 100%); color: white;">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Add Financial Record</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRecordForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Transaction Type *</label>
                                    <select class="form-select" id="recordType" required onchange="updateCategoryOptions()">
                                        <option value="">Select Type</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Amount ($) *</label>
                                    <input type="number" class="form-control" id="recordAmount" step="0.01" min="0.01" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Category *</label>
                                    <select class="form-select" id="recordCategory" required>
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Subcategory</label>
                                    <select class="form-select" id="recordSubcategory">
                                        <option value="">Select Subcategory</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description *</label>
                            <input type="text" class="form-control" id="recordDescription" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Transaction Date *</label>
                                    <input type="date" class="form-control" id="recordDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Payment Method</label>
                                    <select class="form-select" id="recordPaymentMethod">
                                        <option value="Cash">Cash</option>
                                        <option value="Check">Check</option>
                                        <option value="Credit Card">Credit Card</option>
                                        <option value="Zelle">Zelle</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Event Name (if applicable)</label>
                                    <input type="text" class="form-control" id="recordEventName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Vendor/Payer Name</label>
                                    <input type="text" class="form-control" id="recordVendor">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="recordNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-add-record" onclick="saveRecord()">
                        <i class="fas fa-save me-1"></i>Save Record
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Category definitions (must match backend)
        const INCOME_CATEGORIES = {
            'membership': ['New Member', 'Renewal', 'Family', 'Individual', 'Student'],
            'event': ['Durga Puja', 'Kali Puja', 'Saraswati Puja', 'Poila Boishakh', 'Picnic', 'Other'],
            'sponsorship': ['Platinum', 'Gold', 'Silver', 'Bronze', 'Other'],
            'donation': ['General', 'Scholarship', 'Event', 'Emergency Relief'],
            'other_income': ['Interest', 'Refunds', 'Miscellaneous']
        };
        
        const EXPENSE_CATEGORIES = {
            'venue': ['Event Venue', 'Equipment Rental', 'Tables & Chairs'],
            'food': ['Catering', 'Groceries', 'Beverages', 'Supplies'],
            'entertainment': ['Performers', 'Sound System', 'Decorations', 'DJ'],
            'supplies': ['Office Supplies', 'Event Supplies', 'Printing'],
            'technology': ['Website', 'Software', 'Equipment'],
            'administrative': ['Bank Fees', 'Insurance', 'Legal', 'Registration']
        };
        
        // Initialize date filters
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const yearStart = new Date(today.getFullYear(), 0, 1);
            
            document.getElementById('startDate').value = yearStart.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('recordDate').value = today.toISOString().split('T')[0];
            
            initCharts();
            loadLedgerData();
        });
        
        function updateCategoryOptions() {
            const type = document.getElementById('recordType').value;
            const categorySelect = document.getElementById('recordCategory');
            const subcategorySelect = document.getElementById('recordSubcategory');
            
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            const categories = type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
            
            for (const [key, subs] of Object.entries(categories)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                categorySelect.appendChild(option);
            }
        }
        
        document.getElementById('recordCategory').addEventListener('change', function() {
            const type = document.getElementById('recordType').value;
            const category = this.value;
            const subcategorySelect = document.getElementById('recordSubcategory');
            
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            
            const categories = type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;
            const subcategories = categories[category] || [];
            
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subcategorySelect.appendChild(option);
            });
        });
        
        async function saveRecord() {
            const form = document.getElementById('addRecordForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const recordData = {
                transactionType: document.getElementById('recordType').value,
                amount: parseFloat(document.getElementById('recordAmount').value),
                category: document.getElementById('recordCategory').value,
                subcategory: document.getElementById('recordSubcategory').value,
                description: document.getElementById('recordDescription').value,
                transactionDate: document.getElementById('recordDate').value,
                paymentMethod: document.getElementById('recordPaymentMethod').value,
                eventName: document.getElementById('recordEventName').value,
                vendorName: document.getElementById('recordVendor').value,
                notes: document.getElementById('recordNotes').value
            };
            
            console.log('Saving record:', recordData);
            
            /* Actual Wix Velo code:
            import { addFinancialRecord } from 'backend/accounting-ledger.jsw';
            
            const result = await addFinancialRecord({
                ...recordData,
                adminId: currentAdmin._id,
                adminName: currentAdmin.fullName
            });
            
            if (result.success) {
                // Close modal and refresh
            }
            */
            
            alert('Record saved successfully!\nReceipt: BANF-' + (recordData.transactionType === 'income' ? 'INC' : 'EXP') + '-' + Date.now());
            bootstrap.Modal.getInstance(document.getElementById('addRecordModal')).hide();
        }
        
        async function approveRecord(recordId) {
            if (confirm('Are you sure you want to approve this record?')) {
                /* Actual Wix Velo code:
                import { approveFinancialRecord } from 'backend/accounting-ledger.jsw';
                
                const result = await approveFinancialRecord(recordId, currentAdmin._id, currentAdmin.fullName);
                */
                alert('Record approved!');
            }
        }
        
        async function exportLedger() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            /* Actual Wix Velo code:
            import { exportLedgerToCSV } from 'backend/accounting-ledger.jsw';
            
            const result = await exportLedgerToCSV(startDate, endDate);
            if (result.success) {
                // Download the CSV
                const blob = new Blob([result.csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = result.filename;
                a.click();
            }
            */
            
            alert('CSV export initiated for ' + startDate + ' to ' + endDate);
        }
        
        function applyFilters() {
            loadLedgerData();
        }
        
        async function loadLedgerData() {
            // This would call the backend
            /* Actual Wix Velo code:
            import { getLedgerEntries, getFinancialSummary } from 'backend/accounting-ledger.jsw';
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const type = document.getElementById('filterType').value;
            
            const [ledgerResult, summaryResult] = await Promise.all([
                getLedgerEntries(startDate, endDate, type),
                getFinancialSummary(startDate, endDate)
            ]);
            */
            
            // Update summary with sample data
            document.getElementById('totalIncome').textContent = '$23,885.00';
            document.getElementById('totalExpense').textContent = '$5,230.00';
            document.getElementById('netBalance').textContent = '$18,655.00';
            document.getElementById('pendingCount').textContent = '3';
            document.getElementById('transactionCount').textContent = '127 transactions';
        }
        
        function initCharts() {
            // Monthly Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Income',
                        data: [5200, 3100, 2800, 4500, 2100, 1800, 2200, 3400, 8500, 12000, 4200, 3500],
                        backgroundColor: 'rgba(40, 167, 69, 0.7)'
                    }, {
                        label: 'Expenses',
                        data: [1200, 800, 1500, 2200, 900, 600, 1100, 1800, 6200, 8500, 2100, 1400],
                        backgroundColor: 'rgba(220, 53, 69, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Membership', 'Events', 'Sponsorship', 'Donations'],
                    datasets: [{
                        data: [12500, 8200, 2500, 685],
                        backgroundColor: ['#006A4E', '#28a745', '#ffc107', '#17a2b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    </script>
</body>
</html>
